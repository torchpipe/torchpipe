name: Build and Publish Manylinux Wheels

on:
  push:
    tags: [ 'v*' ]
  pull_request:
    branches: [ v1 ]

env:
  PROJECT_ROOT: ${{ github.workspace }}/build-${{ github.run_id }}

jobs:
  build-wheels:
    strategy:
      matrix:
        platform: [manylinux2014, manylinux2_28]
    runs-on: [self-hosted, linux, X64]
    steps:
      - name: Prepare workspace
        run: mkdir -p $PROJECT_ROOT

      - uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 1
          path: $PROJECT_ROOT

      - name: Login to Docker Registry
        if: matrix.platform == 'manylinux2014'  # 按需配置
        uses: docker/login-action@v3
        with:
          registry: your-registry.com
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PAT }}

      - name: Build Docker image with cache
        run: |
          docker buildx build \
            --cache-from type=registry,ref=your-registry.com/${{ matrix.platform }}-cache:latest \
            --cache-to type=registry,ref=your-registry.com/${{ matrix.platform }}-cache:latest \
            -t ${{ matrix.platform }} \
            -f docker/Dockerfile.${{ matrix.platform }} \
            docker/

      - name: Generate wheels
        run: |
          mkdir -p $PROJECT_ROOT/wheelhouse
          docker run --rm -v $PROJECT_ROOT:/src ${{ matrix.platform }} \
            bash -c "cd /src && \
              bash scripts/generate_${{ matrix.platform }}.sh && \
              bash scripts/pytest_${{ matrix.platform }}.sh && \
              cp wheelhouse/*.whl /src/wheelhouse/"

      - name: Verify artifacts
        run: |
          if [ ! -d "$PROJECT_ROOT/wheelhouse" ]; then
            echo "::error::No wheelhouse directory found"
            exit 1
          fi
          if [ -z "$(ls $PROJECT_ROOT/wheelhouse/*.whl)" ]; then
            echo "::error::No wheel files generated"
            exit 1
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-wheels
          path: $PROJECT_ROOT/wheelhouse
          if-no-files-found: error

      - name: Cleanup
        if: always()
        run: rm -rf $PROJECT_ROOT

  publish-to-pypi:
    needs: build-wheels
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: [self-hosted, linux, X64]
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: *-wheels

      - name: Combine wheels
        run: |
          mkdir -p wheelhouse
          # 使用更健壮的版本检测
          latest_version=$(
            find artifacts -name '*.whl' -printf '%f\n' | 
            grep -Eo '[0-9]+\.[0-9]+\.[0-9]+([a-zA-Z0-9\.\+-]+)?' | 
            sort -V | tail -n1
          )
          
          if [ -z "$latest_version" ]; then
            echo "::error::Version detection failed"
            exit 1
          fi

          echo "Selected version: $latest_version"
          find artifacts -name "*$latest_version*" -exec cp {} wheelhouse/ \;

          # 验证文件数量
          file_count=$(ls wheelhouse/*.whl | wc -l)
          if [ "$file_count" -lt 2 ]; then
            echo "::error::Missing platform wheels (found $file_count)"
            exit 1
          fi

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
          verify-metadata: true
          skip-existing: true

      - name: Cleanup
        run: rm -rf artifacts wheelhouse