// aspect_test.cpp

#include <gtest/gtest.h>
#include "aspect.hpp"
#include  "hami/core/reflect.h"
#include <unordered_map>
#include <string>
#include <any>

namespace hami {

// 模拟 dict 类型
using dict = std::shared_ptr<std::unordered_map<std::string, std::any>>;

class AspectTest : public ::testing::Test {
 protected:
  std::unique_ptr<Backend> aspect;

  void SetUp() override {
    // 使用HAMI_CREATE创建Aspect实例
    aspect = std::unique_ptr<Backend>(HAMI_CREATE(Backend, "Aspect"));
    ASSERT_NE(aspect, nullptr);
  }
};

TEST_F(AspectTest, InitializationTest) {
  std::unordered_map<std::string, std::string> config = {{"aspect", "AsyncGuard,AsyncRestart"}};
  dict kwargs;

  // 测试初始化
  EXPECT_NO_THROW(aspect->init(config, kwargs));
}

TEST_F(AspectTest, ForwardTest) {
  std::unordered_map<std::string, std::string> config = {{"aspect", "AsyncGuard,AsyncRestart"}};
  dict kwargs;
  aspect->init(config, kwargs);

  std::vector<dict> inputs = {{{"key1", "value1"}}, {{"key2", "value2"}}};

  // 测试forward方法
  EXPECT_NO_THROW(aspect->forward(inputs));
}

TEST_F(AspectTest, MinMaxTest) {
  std::unordered_map<std::string, std::string> config = {{"aspect", "AsyncGuard,AsyncRestart"}};
  dict kwargs;
  aspect->init(config, kwargs);

  // 测试min和max方法
  EXPECT_GT(aspect->min(), 0);
  EXPECT_GT(aspect->max(), 0);
}

// 添加更多测试用例来覆盖Aspect类的其他功能

}  // namespace hami
