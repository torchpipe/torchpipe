from helper import exp_config_parser
import json
import matplotlib.pyplot as plt
import numpy as np

module_latency_rtx4090_256 = {'clip': {'1': 0.012474376764148474, '2': 0.012474376764148474, '3': 0.012474376764148474, '4': 0.012558511504903436, '5': 0.012788628870621323, '6': 0.0129229333717376, '7': 0.012932872660458087, '8': 0.01306182999163866, '9': 0.014510652627795934, '10': 0.014318388616666199, '11': 0.015580848082900048, '12': 0.014216580241918565, '13': 0.01398760238662362, '14': 0.014092422015964985, '15': 0.014165295204147697, '16': 0.014403185434639454, '17': 0.014741145772859454, '18': 0.01453672667965293, '19': 0.01454892372712493, '20': 0.014730218267068267, '21': 0.014871926130726933, '22': 0.014901460092514753, '23': 0.01522523364983499, '24': 0.01534966727718711, '25': 0.015416669556871057, '26': 0.01574965347535908, '27': 0.015748401507735252, '28': 0.01591687535867095, '29': 0.015978783695027234, '30': 0.01725494572892785, '31': 0.016560928178951145, '32': 0.01645969459787011, '33': 0.016594909681007266, '34': 0.01677121642045677, '35': 0.017284706411883236, '36': 0.017606865325942637, '37': 0.01755879770964384, '38': 0.01776973676867783, '39': 0.018063285537064076, '40': 0.018152701165527106}, "unet": {"1": 0.03305803346058762, "2": 0.03246075380717308, "3": 0.03334193337962546, "4": 0.03592328585807958, "5": 0.034633072449123815, "6": 0.0367765142131717, "7": 0.03872685558786711, "8": 0.03945022503580524, "9": 0.04687323158523485, "10": 0.04627723328541128, "11": 0.04998181570245295, "12": 0.05545559861906329, '13': 0.06570890220813454, '14': 0.07100141234695911, '15': 0.07328080205246806, '16': 0.07591824806295336, '17': 0.08146004512906074, '18': 0.08157065802719445, '19': 0.0846785593777895, '20': 0.08814602478407324, '21': 0.09209374040365219, '22': 0.09869908122345805, '23': 0.10155065590515733, '24': 0.1039102641493082, '25': 0.11151734471321106, '26': 0.11950038983020932, '27': 0.1221927992021665, '28': 0.12548228117171675, '29': 0.12859780826140196, '30': 0.1320568386791274, '31': 0.13403273114003242, '32': 0.13587075640447438, '33': 0.14620376070495694, '34': 0.14759612683206796, '35': 0.150946809113957, '36': 0.15429785173851995, '37': 0.15909588349051773, '38': 0.161613528043963, '39': 0.1736784762982279,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         '40': 0.17631793598644435}, 'vae': {'1': 0.010051007685251533, '2': 0.015773355052806436, '3': 0.02298718993552029, '4': 0.031195681937970222, '5': 0.0403979274444282, '6': 0.04736588289961219, '7': 0.055613140831701456, '8': 0.06364026418887078, '9': 0.07232829523272813, '10': 0.08054304982069879, '11': 0.09089413553010672, '12': 0.09953559825662524, '13': 0.10977120802272111, '14': 0.1185326371807605, '15': 0.12669599633663892, '16': 0.1348925462923944, '17': 0.14437405702192335, '18': 0.15271617132239043, '19': 0.16071462186519056, '20': 0.1690435196971521, '21': 0.1781171625247225, '22': 0.18649539642501622, '23': 0.1897271171445027, '24': 0.20096263592131436, '25': 0.20694523139391094, '26': 0.21517597420606763, '27': 0.22299641878344117, '28': 0.23068457033950834, '29': 0.23956307345069944, '30': 0.24752458727452903, '31': 0.25550214562099427, '32': 0.26326403284911065, '33': 0.27165914939250796, '34': 0.2796974290162325, '35': 0.28824166415724906, '36': 0.30226541878655555, '37': 0.30636822546366604, '38': 0.31468988093547523, '39': 0.3229310984024778, '40': 0.33085627858527006}, 'safety': {'1': 0.0417292199190706, '2': 0.041563717965036634, '3': 0.06280139205977321, '4': 0.08411508755758405, '5': 0.10518699841573835, '6': 0.12902892417274414, '7': 0.1494296956900507, '8': 0.17310933298431336, '9': 0.19601270590908826, '10': 0.22731298906728625, '11': 0.25593423963524403, '12': 0.26365003039129076, '13': 0.28114451761357484, '14': 0.30578165215440095, '15': 0.32366123630665244, '16': 0.36839930947870014, '17': 0.3885221444722265, '18': 0.4180576408933848, '19': 0.4335001892130822, '20': 0.46123311412520707, '21': 0.5040064617991448, '22': 0.5052870756480843, '23': 0.5236162622459233, '24': 0.5464271922409535, '25': 0.5904989183787257, '26': 0.5865158761106432, '27': 0.6318265849910677, '28': 0.6753438641503453, '29': 0.708720679813996, '30': 0.7105849677789956, '31': 0.7055025860294699, '32': 0.7490916519518942, '33': 0.7440436743106693, '34': 0.7824209834448993, '35': 0.8142067297175527, '36': 0.8439213963784278, '37': 0.8747435247059911, '38': 0.9213549491483718, '39': 0.9254748675134032, '40': 0.9409719249047339}}

# 从文件加载你的profile结果
latency_profile = exp_config_parser.get_latency_profile()

# 准备绘图数据


def prepare_data(module_data):
    module_data = {int(k): (v) for k, v in module_data.items()}
    batch_sizes = sorted([int(k) for k in module_data.keys()])
    latencies = [float(module_data[bs])/bs for bs in batch_sizes]
    return np.array(batch_sizes), np.array(latencies)


# 创建对比图
plt.figure(figsize=(15, 10))

# 为每个模块创建子图
modules = ['clip', 'unet', 'vae', 'safety']
titles = ['CLIP Latency Comparison', 'UNet Latency Comparison',
          'VAE Latency Comparison', 'Safety Checker Latency Comparison']

for i, (module, title) in enumerate(zip(modules, titles)):
    plt.subplot(2, 2, i+1)

    # 绘制RTX4090数据
    bs_4090, latency_4090 = prepare_data(module_latency_rtx4090_256[module])
    plt.plot(bs_4090, latency_4090, 'b-', label='pytorch', marker='o')

    # 绘制你的profile数据
    bs_profile, latency_profile_data = prepare_data(latency_profile[module])
    plt.plot(bs_profile, latency_profile_data, 'r-', label='trt', marker='x')

    plt.title(title)
    plt.xlabel('Batch Size')
    plt.ylabel('Latency (s)')
    plt.grid(True)
    plt.legend()

plt.tight_layout()
plt.savefig('tmp/latency_comparison.png', dpi=300, bbox_inches='tight')
print(f'saved to tmp/latency_comparison.png')
plt.show()

# 创建总延迟对比图
plt.figure(figsize=(10, 6))

# 计算总延迟


def calculate_total_latency(module_data):
    batch_sizes = sorted([int(k) for k in module_data['clip'].keys()])
    total_latency = np.zeros(len(batch_sizes))
    for module in modules:
        bs, latencies = prepare_data(module_data[module])
        total_latency += latencies
        # print(latencies)
    return bs, total_latency


# RTX4090总延迟
bs_4090, total_4090 = calculate_total_latency(module_latency_rtx4090_256)

# 你的profile总延迟
bs_profile, total_profile = calculate_total_latency(latency_profile)

plt.plot(bs_4090, total_4090, 'b-', label='RTX4090 Total', marker='o')
plt.plot(bs_profile, total_profile, 'r-',
         label='Your Profile Total', marker='x')

plt.title('Total Pipeline Latency Comparison')
plt.xlabel('Batch Size')
plt.ylabel('Total Latency (s)')
plt.grid(True)
plt.legend()
plt.savefig('tmp/total_latency_comparison.png', dpi=300, bbox_inches='tight')
plt.show()
